<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ffospushhelper demo</title>
    <link rel="stylesheet" href="./assets/normalize.css" />
    <link rel="stylesheet" href="./assets/main.css" />
    <style>
      /* begin demo embedded styles */

      /* end demo embedded styles */
    </style>
  </head>
  <body>
    <h1>ffospushhelper demo</h1>

    <!-- begin demo markup -->
    <h2>Try this on a Firefox OS phone</h2>
    <!-- end demo markup -->

    <p>See the <a href="http://arcturus.github.io/ffospushhelper">project homepage</a>.
    <p>Check out the <a href="https://github.com/arcturus/ffospushhelper">project repo</a>.
    <p>Copyright 2014 Francisco Jordano</p>

    <script src="./ffospushhelper.js"></script>

    <script>
      /* begin demo script */

      // Perform a request against the simplepushclient server
      var doRequest = function doPost(type, uri, data, cb) {
        var xhr = new XMLHttpRequest({mozSystem: true});

        xhr.onload = function onLoad(evt) {
          if (xhr.status === 200 || xhr.status === 0) {
            cb(null, xhr.response);
          } else {
            cb(xhr.status);
          }
        };
        xhr.open(type, uri, true);
        xhr.onerror = function onError(e) {
          console.error('onerror en xhr ' + xhr.status);
          cb(e);
        }
        xhr.send(data);
      };

      window.PushHelper.listen('messages', 
        function(version, endPoint, callback) {
          doRequest('GET', 'http://simplepushclient.eu01.aws.af.cm/api/v1/' +
            version + '?client=' + endPoint,
            function(err, data) {
              if (err) {
                alert('Cannot get message with version ' + version);
              }
              callback(data);
            });
        }, 
        function(message) {
          alert(message);
        }
      ).register(function(channels) {
        var channel = channels[0];
        var data = new FormData();
        data.append('client', channel.endPoint);
        doRequest('POST', 'http://simplepushclient.eu01.aws.af.cm/api/v1/register', data,
          function(err, res) {
            if (err) {
              alert('Error registering');
            } else {
              alert('Register to receive push notifications');
            }
          });
      }).init();

      /* end demo script */
    </script>
  </body>
</html>
