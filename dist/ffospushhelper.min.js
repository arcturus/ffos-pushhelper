/*! ffospushhelper 11-02-2014 */
"use strict";var PushHelper=function(){if(void 0===typeof navigator.push)throw new Error("No Simple Push API available");var a=[],b=[],c=0,d=null,e=[],f=!1,g=function(a){f&&console.log("Do I have channel "+a);var b=localStorage[a];return b?JSON.parse(b):null},h=function(a){var c={name:a.name,endPoint:a.endPoint};b.push(c),localStorage[a.name]=JSON.stringify(c),localStorage[a.endPoint]=a.name},i=function(b,c,d){if(!b||!d)throw new Error("Invalid parameters please check documentation");var e=g(b);e||(e={endPoint:null}),e.resolver=c,e.data=d,e.name=b,a.push(e),f&&console.log("Channels is "+a)},j=function(b){d=b,a.forEach(function(a){a.endPoint?f&&(console.log("We already have the channel "+a.endPoint),l()):k(a)})},k=function(a){f&&console.log("Registering channel "+a.name+" (performing navigator.push.register)");var b=navigator.push.register();c++,b.onsuccess=function(){f&&console.log("Successfully registered channel "+a.name);var d=b.result;a.endPoint=d,h(a),c--,l()},b.onerror=function(){f&&console.log("Error registering channel "+a.name),e.push({type:"register",data:a.name}),c--,l()}},l=function(){0===c&&null!==d&&(f&&console.log("Finished the registering, telling the server "+JSON.stringify(a)),d(b))},m=function(){window.navigator.mozSetMessageHandler("push",function(b){var c=b.pushEndpoint,d=b.version;console.log("Receivied a push message: "+c+" : "+d);var e=a.find(function(a){return a.endPoint===c?a:void 0});return void 0===e?void console.warn("Unknown channel via endpoint "+c+" with version "+d):void(e.resolver?e.resolver(d,c,e.data):e.data())})},n=function(b){b&&Array.isArray(b)&&(a=[],b.forEach(function(a){var b=JSON.parse(localStorage[a]);delete localStorage[b.endPoint],delete localStorage[a]}))};return{listen:i,register:j,init:m,reset:n,set debug(a){f=!!a}}}();void 0===typeof module&&window?window.PushHelper=PushHelper:window||(module.exports=PushHelper);