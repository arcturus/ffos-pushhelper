/*! ffospushhelper 20-02-2014 */
"use strict";var PushHelper=function(){function a(a){var c;return b?(b.forEach(function(b){b.endPoint===a&&(c=b)}),c):c}if(void 0===typeof navigator.push)throw new Error("No Simple Push API available");var b=[],c=[],d=0,e=null,f=[],g=!1,h=function(a){g&&console.log("Do I have channel "+a);var b=localStorage[a];return b?JSON.parse(b):null},i=function(a){var b={name:a.name,endPoint:a.endPoint};c.push(b),localStorage[a.name]=JSON.stringify(b),localStorage[a.endPoint]=a.name},j=function(a,c,d){if(!a||!d)throw new Error("Invalid parameters please check documentation");var e=h(a);e||(e={endPoint:null}),e.resolver=c,e.data=d,e.name=a,b.push(e),g&&console.log("Channels is "+b)},k=function(a){e=a,b.forEach(function(a){a.endPoint?g&&(console.log("We already have the channel "+a.endPoint),m()):l(a)})},l=function(a){g&&console.log("Registering channel "+a.name+" (performing navigator.push.register)");var b=navigator.push.register();d++,b.onsuccess=function(){g&&console.log("Successfully registered channel "+a.name);var c=b.result;a.endPoint=c,i(a),d--,m()},b.onerror=function(){g&&console.log("Error registering channel "+a.name),f.push({type:"register",data:a.name}),d--,m()}},m=function(){0===d&&null!==e&&(g&&console.log("Finished the registering, telling the server "+JSON.stringify(c)),e(c))},n=function(){window.navigator.mozSetMessageHandler("push",function(b){var c=b.pushEndpoint,d=b.version;console.log("Receivied a push message: "+c+" : "+d);var e=a(c);return void 0===e?void console.warn("Unknown channel via endpoint "+c+" with version "+d):void(e.resolver?e.resolver(d,c,e.data):e.data())})},o=function(a){b=[],c=[],a&&Array.isArray(a)&&a.forEach(function(a){var b=JSON.parse(localStorage[a]);delete localStorage[b.endPoint],delete localStorage[a]})};return{listen:j,register:k,init:n,reset:o,set debug(a){g=!!a}}}();void 0===typeof module&&window?window.PushHelper=PushHelper:window||(module.exports=PushHelper);