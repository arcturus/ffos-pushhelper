/*! ffospushhelper 31-01-2014 */
"use strict";var PushHelper=function(){if(void 0===typeof navigator.push)throw new Error("No Simple Push API available");var a=[],b=0,c=null,d=[],e=!1,f=function(a){e&&console.log("Do I have channel "+a);var b=localStorage[a];return b?JSON.parse(b):null},g=function(a){var b={name:a.name,endPoint:a.endPoint};localStorage[a.name]=JSON.stringify(b),localStorage[a.endPoint]=a.name},h=function(b,c,d){if(!b||!d)throw new Error("Invalid parameters please check documentation");var g=f(b);g||(g={endPoint:null}),g.resolver=c,g.data=d,g.name=b,a.push(g),e&&console.log("Channels is "+a)},i=function(b){c=b,a.forEach(function(a){a.endPoint?e&&(console.log("We already have the channel "+a.endPoint),k()):j(a)})},j=function(a){e&&console.log("Registering channel "+a.name+" (performing navigator.push.register)");var c=navigator.push.register();b++,c.onsuccess=function(){e&&console.log("Successfully registered channel "+a.name);var d=c.result;a.endPoint=d,g(a),b--,k()},c.onerror=function(){e&&console.log("Error registering channel "+a.name),d.push({type:"register",data:a.name}),b--,k()}},k=function(){0===b&&null!==c&&(e&&console.log("Finished the registering, telling the server "+JSON.stringify(a)),c(a))},l=function(){window.navigator.mozSetMessageHandler("push",function(b){var c=b.pushEndpoint,d=b.version;console.log("Receivied a push message: "+c+" : "+d);var e=a.find(function(a){return a.endPoint===c?a:void 0});return void 0===e?void console.warn("Unknown channel via endpoint "+c+" with version "+d):void(e.resolver?e.resolver(d,c,e.data):e.data())})};return{listen:h,register:i,init:l,set debug(a){e=!!a}}}();void 0===typeof module&&window?window.PushHelper=PushHelper:window||(module.exports=PushHelper);